/* hist.c */

#include <math.h>
#include <stdint.h>

#include "framework.h"
#include "hist.h"
#include "tap.h"

#define SIGMA 7

#define countof(x) (sizeof(x) / sizeof((x)[0]))

static const uint32_t hist_in[] = {
  42519, 105229, 36285, 25162, 25162, 23208, 21252, 20382,
  19820, 18312,  17649, 17991, 17796, 18585, 18303, 19463,
  20265, 20868,  22197, 21573, 22578, 22767, 21883, 22665,
  23560, 23832,  24225, 24657, 26214, 26895, 26586, 28128,
  27045, 26898,  27723, 27417, 28305, 26756, 25710, 23196,
  23787, 29460,  32802, 32421, 32043, 31296, 29544, 29349,
  28053, 26151,  20832, 19113, 17718, 16110, 16668, 16032,
  17505, 17244,  15429, 15498, 15198, 14886, 15546, 14286,
  14289, 13926,  13730, 13719, 13884, 13602, 13476, 13693,
  13311, 12753,  13044, 12753, 12321, 11743, 11946, 11478,
  11313, 11157,  10516, 10308, 10395, 10473, 10587, 10320,
  10071, 10335,  10458, 10434, 9537,  9561,  9975,  9282,
  9255,  10361,  10593, 8727,  10650, 9648,  7995,  9156,
  8433,  7386,   7851,  7194,  7693,  6435,  6231,  6264,
  6120,  5772,   5481,  5458,  4989,  4725,  4398,  4401,
  4413,  4389,   4220,  3894,  3915,  4035,  4062,  3786,
  3759,  3777,   3795,  3447,  3498,  3414,  3687,  3570,
  3435,  3738,   3342,  3204,  3246,  3033,  2868,  2787,
  2619,  2556,   2562,  2679,  2340,  2445,  2538,  2394,
  2238,  2151,   2301,  2361,  2199,  2277,  2298,  2307,
  2148,  2301,   2307,  2265,  2598,  2223,  2592,  2394,
  2427,  2409,   2202,  2169,  1965,  1869,  1785,  1833,
  1965,  1902,   1875,  1902,  1869,  1887,  1761,  1620,
  1605,  1584,   1533,  1455,  1491,  1425,  1380,  1395,
  1479,  1206,   1317,  1239,  1104,  1143,  1353,  1179,
  1104,  1161,   1140,  1170,  1110,  1080,  1212,  1338,
  1239,  1320,   1317,  1260,  1233,  1290,  1446,  1377,
  1449,  1392,   1434,  1458,  1401,  1413,  1374,  1530,
  1716,  1707,   1674,  1800,  1725,  1779,  1731,  2019,
  1950,  2064,   2085,  1989,  1803,  2037,  1728,  1827,
  1611,  1728,   2160,  1506,  2346,  1467,  3261,  1668,
  3843,  2292,   4656,  4203,  4776,  6240,  3546,  7444
};

static const double fwd_map[] = {
  0, 0, 0, 0, 0, 0, 0, 0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2,
  2.125, 2.25, 2.375, 2.5, 2.625, 2.75, 2.875, 3, 3.25, 3.5, 3.75,
  4, 4.5, 5, 6, 7, 7.25, 7.5, 7.75, 8, 8.25, 8.5, 8.75, 9, 9.5, 10,
  11, 12, 12.5, 13, 13.5, 14, 14.5, 15, 16, 17, 17.5, 18, 18.5, 19,
  19.25, 19.5, 19.75, 20, 20.5, 21, 22, 23, 23.25, 23.5, 23.75, 24,
  24.5, 25, 25.5, 26, 26.25, 26.5, 26.75, 27, 27.25, 27.5, 27.75,
  28, 28.25, 28.5, 28.75, 29, 29.5, 30, 31, 32, 32.25, 32.5, 32.75,
  33, 33.5, 34, 34.5, 35, 35.25, 35.5, 35.75, 36, 36.25, 36.5,
  36.75, 37, 37.25, 37.5, 37.75, 38, 38.5, 39, 40, 41, 41.125,
  41.25, 41.375, 41.5, 41.625, 41.75, 41.875, 42, 42.25, 42.5,
  42.75, 43, 43.5, 44, 44.6666666666667, 45.3333333333333, 46,
  46.25, 46.5, 46.75, 47, 47.25, 47.5, 47.75, 48, 48.25, 48.5,
  48.75, 49, 49.5, 50, 51.5, 53, 53.25, 53.5, 53.75, 54, 54.5, 55,
  55.5, 56, 56.5, 57, 57.5, 58, 58.5, 59, 60.5, 62, 62.25, 62.5,
  62.75, 63, 63.5, 64, 65, 66, 66.5, 67, 67.5, 68, 68.5, 69, 71,
  73, 73.25, 73.5, 73.75, 74, 74.5, 75, 76.5, 78, 78.5, 79, 80, 81,
  81.5, 82, 84, 86, 86.5, 87, 87.5, 88, 88.5, 89, 90.5, 92, 93.5,
  95, 96, 97, 97.5, 98, 99.5, 101, 101.5, 102, 103.5, 105, 106,
  107, 109, 111, 111.5, 112, 114, 116, 117.5, 119, 121.5, 124,
  125.5, 127, 130, 133, 135.5, 138, 141.5, 145, 148, 151, 155, 159,
  162.5, 166, 171, 176, 181.5, 187, 193.5, 200, 207.5, 215, 221,
  227, 231, 235, 240.5, 246, 249, 252, 253
};

static const double rev_map[] = {
  10, 14, 22, 26, 28, 29, 30, 34, 38, 40, 41, 42, 44, 46, 48, 49,
  50, 52, 54, 58, 60, 61, 62, 66, 68, 70, 74, 78, 82, 84, 85, 86,
  90, 92, 94, 98, 102, 106, 108, 109, 110, 118, 122, 124, 126,
  127, 131, 135, 139, 141, 142, 143, 145, 147, 149, 151, 153, 155,
  157, 158, 159, 161, 163, 165, 166, 167, 169, 171, 173, 174,
  174.5, 175, 177, 179, 181, 182, 183, 184, 185, 186, 187, 189,
  190, 190.5, 191, 192, 193, 195, 197, 198, 199, 199.5, 200, 201,
  201.5, 202, 203, 205, 206, 207, 208, 209, 210, 211, 211.5, 212,
  213, 214, 214.5, 215, 216, 217, 218, 218.5, 219, 219.5, 220,
  221, 221.5, 222, 222.5, 223, 223.333333333333, 223.666666666667,
  224, 225, 225.5, 226, 226.333333333333, 226.666666666667, 227,
  227.333333333333, 227.666666666667, 228, 228.5, 229,
  229.333333333333, 229.666666666667, 230, 230.333333333333,
  230.666666666667, 231, 231.25, 231.5, 231.75, 232,
  232.333333333333, 232.666666666667, 233, 233.333333333333,
  233.666666666667, 234, 234.25, 234.5, 234.75, 235, 235.25,
  235.5, 235.75, 236, 236.333333333333, 236.666666666667, 237,
  237.25, 237.5, 237.75, 238, 238.2, 238.4, 238.6, 238.8, 239,
  239.2, 239.4, 239.6, 239.8, 240, 240.2, 240.4, 240.6, 240.8,
  241, 241.166666666667, 241.333333333333, 241.5,
  241.666666666667, 241.833333333333, 242, 242.166666666667,
  242.333333333333, 242.5, 242.666666666667, 242.833333333333,
  243, 243.142857142857, 243.285714285714, 243.428571428571,
  243.571428571429, 243.714285714286, 243.857142857143, 244,
  244.142857142857, 244.285714285714, 244.428571428571,
  244.571428571429, 244.714285714286, 244.857142857143, 245,
  245.125, 245.25, 245.375, 245.5, 245.625, 245.75, 245.875, 246,
  246.166666666667, 246.333333333333, 246.5, 246.666666666667,
  246.833333333333, 247, 247.166666666667, 247.333333333333,
  247.5, 247.666666666667, 247.833333333333, 248, 248.25, 248.5,
  248.75, 249, 249.25, 249.5, 249.75, 250, 250.2, 250.4, 250.6,
  250.8, 251, 251.166666666667, 251.333333333333, 251.5,
  251.666666666667, 251.833333333333, 252, 252.333333333333,
  252.666666666667, 253, 253.333333333333, 253.666666666667,
  254, 255, 255, 255
};

static void is_map(const double *got, const double *want, size_t size, const char *name) {
  for (unsigned i = 0; i < size; i++) {
    double err = fabs(got[i] - want[i]);
    if (!ok(err < SIGMA, "%s[%d]", name, i))
      diag("%s[%3d] want: %7.2f got: %7.2f", name, i, want[i], got[i]);
  }
}

void test_main(void) {
  is(countof(hist_in), countof(fwd_map), "countof(hist_in) == countof(fwd_map)");
  is(countof(hist_in), countof(rev_map), "countof(hist_in) == countof(rev_map)");

  double map[countof(hist_in)];

  hist_map(hist_in, countof(hist_in), map);
  is_map(map, fwd_map, countof(fwd_map),  "fwd_map");

  double imap[countof(hist_in)];

  hist_inverse(map, imap, countof(hist_in));
  is_map(imap, rev_map, countof(rev_map),  "rev_map");
}

/* vim:ts=2:sw=2:sts=2:et:ft=c
 */
